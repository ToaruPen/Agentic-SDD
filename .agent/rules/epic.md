# Epic生成ルール

Epic作成時のAI制御ルール。過剰提案を抑止し、シンプルな設計を促す。

---

## 3層構造

- Layer 1: PRD制約（規模感・技術方針・既存制約）
- Layer 2: AIルール（カウント定義・許可/禁止リスト）
- Layer 3: レビュー観点（チェックリスト）

---

## Layer 1: PRD制約

PRDから以下を引き継ぐ：

- 規模感: PRD セクション7
- 技術方針: PRD セクション7
- 既存制約: PRD Q6

---

## Layer 2: AIルール

### カウント定義

- 外部サービス数
  - 定義: ネットワーク越しに依存する別管理のサービス
  - カウント単位: SaaS、マネージドDB、認証基盤、外部API を各1
- コンポーネント数
  - 定義: デプロイ単位
  - カウント単位: 別プロセス、別ジョブ、別ワーカー、別バッチ を各1
- 新規技術
  - 定義: 新規に導入する主要技術カテゴリ
  - カウント単位: DB、キュー、認証、観測基盤、フレームワーク、クラウドサービス を各1

### 許可/禁止リスト

#### シンプル優先

- 外部サービス数: 最大1（例: DBのみ）
- 新規導入ライブラリ: 最大3
- 新規コンポーネント数: 最大3
- 非同期基盤（キュー/イベントストリーム）: 禁止
- マイクロサービス分割: 禁止
- コンテナオーケストレーション（K8s等）: 禁止

#### バランス

- 外部サービス数: 最大3
- 新規導入ライブラリ: 最大5
- 新規コンポーネント数: 最大5
- 非同期基盤: 使う場合は理由を明記
- マイクロサービス分割: する場合は理由を明記

#### 拡張性優先

制限なし。ただし、すべての選択に理由が必要。

### 例外条件

PRDに明記された必須条件がある場合のみ、上記制限を超えることが許可される。

例:
- PRD: 「リアルタイム通知が必須」→ WebSocket/非同期基盤の使用を許可
- PRD: 「認証は既存IdPを使用」→ 外部認証サービスの使用を許可

---

## Layer 3: レビュー観点

### 新規技術カウントのルール

- カウント対象: **新規に導入/提案する技術名・サービス名のみ**
- カウント除外: 既存プロジェクトで使用中の技術

### チェックリスト

```
□ 新規技術/サービス名が5つ以下
□ 新規コンポーネント数が上限以内
□ 各選択に「なぜこれを選んだか」の理由がある
□ 代替案（よりシンプルな方法）が提示されている
□ 「将来のため」だけを理由にした項目がない
□ 必須提出物（外部サービス一覧/コンポーネント一覧/新規技術一覧）が揃っている
```

---

## 必須提出物（3一覧）

Epicには以下の表を**必ず**付ける：

### 外部サービス一覧

外部サービス-1
名称: (例) PostgreSQL
用途: データ永続化
必須理由: RDB必須
代替案: SQLite（小規模なら）

### コンポーネント一覧

コンポーネント-1
名称: (例) API Server
責務: HTTPリクエスト処理
デプロイ形態: コンテナ

### 新規技術一覧

新規技術-1
名称: (例) Redis
既存との差: 新規導入
導入理由: セッション管理

---

## 生成ルール

1. 単純な代替案がある場合は**必ず両方提示**
2. 「シンプル優先」時はモノリシック構成を基本とする
3. 「将来の拡張性」だけを理由にした複雑化は禁止

---

## 違反時の対応

チェックリストに違反がある場合：

1. 違反箇所を指摘
2. シンプルな代替案を提示
3. ユーザーに選択を求める

例:
```
⚠️ 技術方針「シンプル優先」に対して、以下の違反があります：

- 外部サービス数: 3（上限1）
  - AWS S3, Redis, PostgreSQL

提案:
- ファイルストレージをローカルに変更 → S3を削除
- セッションをDBに保存 → Redisを削除

これでよろしいですか？
```

---

## 関連ファイル

- `.agent/commands/create-epic.md` - Epic作成コマンド
- `docs/epics/_template.md` - Epicテンプレート
- `.agent/rules/issue.md` - Issue粒度規約
