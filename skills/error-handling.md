# エラーハンドリングスキル

エラーの分類・処理・通知に関する設計ガイドライン。

---

## 概要

このスキルは、アプリケーションにおけるエラーハンドリングの
設計・実装指針を提供します。
言語/フレームワーク非依存で、概念ベースで記述しています。

---

## エラー分類

### 発生源による分類

| 分類 | 説明 | 例 |
|-----|------|---|
| ユーザーエラー | ユーザーの入力/操作ミス | 必須項目未入力、形式不正 |
| ビジネスエラー | ビジネスルール違反 | 残高不足、権限なし |
| システムエラー | システム内部の問題 | NullPointer、型エラー |
| 外部エラー | 外部サービスの問題 | API タイムアウト、DB接続失敗 |

### 回復可能性による分類

| 分類 | 説明 | 対応 |
|-----|------|------|
| 回復可能 | ユーザーが対処できる | 具体的な対処法を提示 |
| 回復不能（一時的） | リトライで回復可能性あり | リトライボタン提示 |
| 回復不能（永続的） | システム対応が必要 | サポート連絡先を提示 |

---

## エラー処理の原則

### 1. Fail Fast

問題を早期に検出し、明確に失敗させる。

```
// Good: 事前チェックで早期失敗
if (!userId) {
  throw new ValidationError("userId is required");
}

// Bad: nullのまま処理を続行
const user = users.find(u => u.id === userId); // undefined
user.name; // 後でエラー
```

### 2. 適切な粒度でキャッチ

```
// Good: 適切な粒度
try {
  await saveUser(user);
} catch (error) {
  if (error instanceof ValidationError) {
    // バリデーションエラー処理
  } else if (error instanceof DatabaseError) {
    // DBエラー処理
  } else {
    // 予期しないエラー
    throw error;
  }
}

// Bad: 全部キャッチして握りつぶす
try {
  await saveUser(user);
} catch (error) {
  console.log(error); // 何もしない
}
```

### 3. 意味のあるエラーメッセージ

| 対象 | 内容 |
|-----|------|
| ユーザー向け | 何が問題か、どうすればいいか |
| 開発者向け | スタックトレース、コンテキスト |

---

## エラーの伝播

### レイヤー別の責務

```
┌─────────────────────────────────────────┐
│ UI層                                    │
│ - エラーメッセージの表示                  │
│ - ユーザーへの通知                       │
└─────────────────────────────────────────┘
                    ▲
                    │ ユーザー向けメッセージ
                    │
┌─────────────────────────────────────────┐
│ アプリケーション層                        │
│ - エラーの変換（技術的→ユーザー向け）      │
│ - ログ記録                              │
└─────────────────────────────────────────┘
                    ▲
                    │ 技術的エラー
                    │
┌─────────────────────────────────────────┐
│ ドメイン層/インフラ層                     │
│ - 技術的エラーの発生                      │
│ - 適切な例外のスロー                      │
└─────────────────────────────────────────┘
```

---

## ログ出力

### ログレベル

| レベル | 用途 | 例 |
|-------|------|---|
| ERROR | 即時対応が必要 | 決済失敗、DB接続不可 |
| WARN | 注意が必要 | リトライ発生、非推奨API使用 |
| INFO | 正常な重要イベント | ユーザー登録、ログイン |
| DEBUG | デバッグ用 | 関数の入出力、中間状態 |

### ログに含めるべき情報

| 情報 | 説明 |
|-----|------|
| タイムスタンプ | いつ発生したか |
| エラー種別 | どんなエラーか |
| メッセージ | 何が起きたか |
| コンテキスト | リクエストID、ユーザーID等 |
| スタックトレース | どこで発生したか |

### 機密情報の除外

ログに含めてはいけない情報：
- パスワード
- アクセストークン
- クレジットカード番号
- 個人情報（必要に応じてマスク）

---

## ユーザーへの通知

### 通知パターン

| パターン | 用途 | 例 |
|---------|------|---|
| インライン | フィールド単位のエラー | 「メールアドレスが不正です」 |
| トースト | 一時的な通知 | 「保存しました」「エラーが発生しました」 |
| モーダル | 重要な確認が必要 | 「セッションが切れました。再ログインしてください」 |
| 専用ページ | 致命的エラー | 404ページ、500ページ |

### メッセージの書き方

| 良い例 | 悪い例 |
|-------|-------|
| 「メールアドレスの形式が正しくありません」 | 「ValidationError: email」 |
| 「サーバーに接続できません。しばらく待ってからお試しください」 | 「500 Internal Server Error」 |
| 「このページは存在しません」 | 「null pointer exception」 |

---

## リトライ戦略

### リトライすべきエラー

| エラー | リトライ | 理由 |
|-------|---------|------|
| ネットワークタイムアウト | Yes | 一時的な問題 |
| 429 Too Many Requests | Yes（待機後） | レート制限 |
| 503 Service Unavailable | Yes | 一時的な問題 |
| 400 Bad Request | No | リクエストが不正 |
| 401 Unauthorized | No | 認証が必要 |

### Exponential Backoff

```
1回目: 即時
2回目: 1秒後
3回目: 2秒後
4回目: 4秒後
5回目: 8秒後
（最大リトライ回数に達したら失敗）
```

---

## チェックリスト

### 設計時

- [ ] エラーの分類が定義されている
- [ ] 各エラーの処理方針が決まっている
- [ ] ユーザー向けメッセージが定義されている
- [ ] ログ出力の方針が決まっている

### 実装時

- [ ] 適切な粒度で例外をキャッチしている
- [ ] エラーメッセージが具体的で有用
- [ ] 機密情報がログに含まれていない
- [ ] リトライ戦略が実装されている（該当する場合）

### テスト時

- [ ] 正常系だけでなく異常系もテストしている
- [ ] エラーメッセージが正しく表示されることを確認
- [ ] ログが正しく出力されることを確認

---

## アンチパターン

| アンチパターン | 問題 | 改善 |
|---------------|------|------|
| 例外を握りつぶす | 問題が隠蔽される | 適切に処理 or 再スロー |
| 全部同じエラーメッセージ | 原因特定困難 | 具体的なメッセージ |
| 技術的エラーをそのまま表示 | ユーザー混乱 | ユーザー向けに変換 |
| エラー時にデータ消失 | ユーザー体験低下 | 入力データを保持 |
| 無限リトライ | リソース枯渇 | 最大回数を設定 |

---

## 関連ファイル

- `skills/api-endpoint.md` - API設計（エラーレスポンス）
- `skills/testing.md` - テスト設計（異常系テスト）
- `.agent/rules/dod.md` - Definition of Done
