#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"

usage() {
  cat <<'EOF'
Usage:
  tmux --shogun-ops [--dry-run] [--session <name>] [--window <name>]

Description:
  Optional tmux shim to open the Shogun Ops deterministic tmux layout.
  This works only when this script is on PATH as `tmux` (opt-in).

Behavior:
  - `tmux --shogun-ops` runs:
      scripts/shogun-tmux.sh init
      scripts/shogun-tmux.sh attach
  - All other invocations are forwarded to the real tmux binary.
EOF
}

find_real_tmux() {
  local script_dir="$1"

  local p
  IFS=':' read -r -a path_parts <<<"${PATH:-}"
  for p in "${path_parts[@]}"; do
    [[ -n "$p" ]] || continue

    local p_abs=""
    if p_abs="$(cd -- "$p" 2>/dev/null && pwd -P)"; then
      :
    else
      continue
    fi

    if [[ "$p_abs" == "$script_dir" ]]; then
      continue
    fi

    local cand="$p_abs/tmux"
    if [[ -x "$cand" ]]; then
      printf '%s' "$cand"
      return 0
    fi
  done

  return 1
}

if [[ "${1:-}" == "--shogun-ops" ]]; then
  shift

  dry_run=0
  shogun_args=()
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --dry-run)
        dry_run=1
        shift
        ;;
      --session|--window)
        if [[ $# -lt 2 ]]; then
          echo "Missing value for $1" >&2
          exit 2
        fi
        shogun_args+=("$1" "$2")
        shift 2
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        echo "Unknown arg for --shogun-ops: $1" >&2
        usage >&2
        exit 2
        ;;
    esac
  done

  if [[ "$dry_run" -eq 1 ]]; then
    if [[ ${#shogun_args[@]} -gt 0 ]]; then
      shogun_args=(--dry-run "${shogun_args[@]}")
    else
      shogun_args=(--dry-run)
    fi
  fi

  if [[ ${#shogun_args[@]} -gt 0 ]]; then
    "$SCRIPT_DIR/shogun-tmux.sh" "${shogun_args[@]}" init
    "$SCRIPT_DIR/shogun-tmux.sh" "${shogun_args[@]}" attach
  else
    "$SCRIPT_DIR/shogun-tmux.sh" init
    "$SCRIPT_DIR/shogun-tmux.sh" attach
  fi
  exit 0
fi

real_tmux=""
if ! real_tmux="$(find_real_tmux "$SCRIPT_DIR")"; then
  echo "Real tmux binary not found in PATH (after excluding: $SCRIPT_DIR)." >&2
  echo "Next action: install tmux, or do not shadow tmux with this shim." >&2
  exit 127
fi

exec "$real_tmux" "$@"
