# API エンドポイント設計スキル

REST API エンドポイントの設計・実装ガイドライン。

---

## 概要

このスキルは、REST API エンドポイントを設計・実装する際の指針を提供します。
言語/フレームワーク非依存で、概念ベースで記述しています。

---

## 設計原則

### 1. リソース指向

- URLはリソース（名詞）を表す
- 操作はHTTPメソッドで表現

```
GET    /users      # ユーザー一覧取得
GET    /users/:id  # ユーザー詳細取得
POST   /users      # ユーザー作成
PUT    /users/:id  # ユーザー更新（全体）
PATCH  /users/:id  # ユーザー更新（部分）
DELETE /users/:id  # ユーザー削除
```

### 2. 一貫性

- 命名規則を統一（複数形、ケバブケース等）
- レスポンス形式を統一
- エラー形式を統一

### 3. ステートレス

- セッション状態をサーバーに持たない
- 認証情報はリクエストごとに送信

---

## URL設計

### 基本パターン

| パターン | 説明 | 例 |
|---------|------|---|
| `/resources` | コレクション | `/users` |
| `/resources/:id` | 単一リソース | `/users/123` |
| `/resources/:id/sub-resources` | ネスト | `/users/123/posts` |

### 命名規則

| 推奨 | 非推奨 | 理由 |
|-----|-------|------|
| `/users` | `/user` | 複数形で統一 |
| `/user-profiles` | `/userProfiles` | ケバブケース |
| `/users/123` | `/users?id=123` | パスパラメータ |

### クエリパラメータ

| 用途 | パラメータ | 例 |
|-----|----------|---|
| ページネーション | `page`, `limit` | `?page=2&limit=20` |
| ソート | `sort`, `order` | `?sort=created_at&order=desc` |
| フィルタ | フィールド名 | `?status=active` |
| 検索 | `q`, `search` | `?q=keyword` |

---

## HTTPメソッド

| メソッド | 用途 | 冪等性 | 安全性 |
|---------|------|-------|-------|
| GET | 取得 | Yes | Yes |
| POST | 作成 | No | No |
| PUT | 全体更新 | Yes | No |
| PATCH | 部分更新 | No | No |
| DELETE | 削除 | Yes | No |

---

## ステータスコード

### 成功

| コード | 用途 | 例 |
|-------|------|---|
| 200 | 成功（データあり） | GET、PUT、PATCH |
| 201 | 作成成功 | POST |
| 204 | 成功（データなし） | DELETE |

### クライアントエラー

| コード | 用途 | 例 |
|-------|------|---|
| 400 | リクエスト不正 | バリデーションエラー |
| 401 | 認証エラー | 未ログイン |
| 403 | 認可エラー | 権限なし |
| 404 | リソースなし | 存在しないID |
| 409 | 競合 | 重複登録 |
| 422 | 処理不能 | ビジネスロジックエラー |

### サーバーエラー

| コード | 用途 | 例 |
|-------|------|---|
| 500 | サーバーエラー | 予期しないエラー |
| 502 | Bad Gateway | 外部サービスエラー |
| 503 | サービス利用不可 | メンテナンス中 |

---

## リクエスト/レスポンス形式

### リクエストボディ

```json
{
  "name": "John Doe",
  "email": "john@example.com"
}
```

### 成功レスポンス（単一）

```json
{
  "data": {
    "id": "123",
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2024-03-15T10:30:00Z"
  }
}
```

### 成功レスポンス（一覧）

```json
{
  "data": [
    { "id": "123", "name": "John Doe" },
    { "id": "124", "name": "Jane Doe" }
  ],
  "meta": {
    "total": 100,
    "page": 1,
    "limit": 20
  }
}
```

### エラーレスポンス

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力値が不正です",
    "details": [
      { "field": "email", "message": "メールアドレスの形式が不正です" }
    ]
  }
}
```

---

## チェックリスト

### 設計時

- [ ] URLがリソース指向になっている
- [ ] HTTPメソッドが適切に選択されている
- [ ] ステータスコードが適切に定義されている
- [ ] リクエスト/レスポンス形式が統一されている
- [ ] エラーレスポンスが定義されている

### 実装時

- [ ] 入力バリデーションが実装されている
- [ ] 認証・認可が実装されている
- [ ] エラーハンドリングが実装されている
- [ ] ログ出力が適切に行われている
- [ ] テストが作成されている

### セキュリティ

- [ ] 入力がサニタイズされている
- [ ] SQLインジェクション対策がされている
- [ ] XSS対策がされている
- [ ] レート制限が考慮されている
- [ ] 機密情報がレスポンスに含まれていない

---

## アンチパターン

| アンチパターン | 問題 | 改善 |
|---------------|------|------|
| 動詞をURLに含める | `/getUsers` | `GET /users` |
| 全部POSTで処理 | 意図が不明確 | 適切なメソッド使用 |
| ステータスコード200のみ | エラー判定困難 | 適切なコード返却 |
| エラー詳細を常に返す | セキュリティリスク | 本番では概要のみ |

---

## 関連ファイル

- `skills/error-handling.md` - エラーハンドリング
- `skills/testing.md` - テスト設計
- `.agent/rules/dod.md` - Definition of Done
