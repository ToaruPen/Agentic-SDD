# API エンドポイント設計スキル

REST API エンドポイントの設計・実装ガイドライン。

---

## 概要

このスキルは、REST API エンドポイントを設計・実装する際の指針を提供します。
言語/フレームワーク非依存で、概念ベースで記述しています。

---

## 設計原則

### 1. リソース指向

- URLはリソース（名詞）を表す
- 操作はHTTPメソッドで表現

```
GET    /users      # ユーザー一覧取得
GET    /users/:id  # ユーザー詳細取得
POST   /users      # ユーザー作成
PUT    /users/:id  # ユーザー更新（全体）
PATCH  /users/:id  # ユーザー更新（部分）
DELETE /users/:id  # ユーザー削除
```

### 2. 一貫性

- 命名規則を統一（複数形、ケバブケース等）
- レスポンス形式を統一
- エラー形式を統一

### 3. ステートレス

- セッション状態をサーバーに持たない
- 認証情報はリクエストごとに送信

---

## URL設計

### 基本パターン

- `/resources`: コレクション。例: `/users`
- `/resources/:id`: 単一リソース。例: `/users/123`
- `/resources/:id/sub-resources`: ネスト。例: `/users/123/posts`

### 命名規則

- 推奨: `/users` / 非推奨: `/user` / 理由: 複数形で統一
- 推奨: `/user-profiles` / 非推奨: `/userProfiles` / 理由: ケバブケース
- 推奨: `/users/123` / 非推奨: `/users?id=123` / 理由: パスパラメータ

### クエリパラメータ

- ページネーション: `page`, `limit`（例: `?page=2&limit=20`）
- ソート: `sort`, `order`（例: `?sort=created_at&order=desc`）
- フィルタ: フィールド名（例: `?status=active`）
- 検索: `q`, `search`（例: `?q=keyword`）

---

## HTTPメソッド

- GET: 取得（冪等性: Yes / 安全性: Yes）
- POST: 作成（冪等性: No / 安全性: No）
- PUT: 全体更新（冪等性: Yes / 安全性: No）
- PATCH: 部分更新（冪等性: No / 安全性: No）
- DELETE: 削除（冪等性: Yes / 安全性: No）

---

## ステータスコード

### 成功

- 200: 成功（データあり）（例: GET, PUT, PATCH）
- 201: 作成成功（例: POST）
- 204: 成功（データなし）（例: DELETE）

### クライアントエラー

- 400: リクエスト不正（例: バリデーションエラー）
- 401: 認証エラー（例: 未ログイン）
- 403: 認可エラー（例: 権限なし）
- 404: リソースなし（例: 存在しないID）
- 409: 競合（例: 重複登録）
- 422: 処理不能（例: ビジネスロジックエラー）

### サーバーエラー

- 500: サーバーエラー（例: 予期しないエラー）
- 502: Bad Gateway（例: 外部サービスエラー）
- 503: サービス利用不可（例: メンテナンス中）

---

## リクエスト/レスポンス形式

### リクエストボディ

```json
{
  "name": "John Doe",
  "email": "john@example.com"
}
```

### 成功レスポンス（単一）

```json
{
  "data": {
    "id": "123",
    "name": "John Doe",
    "email": "john@example.com",
    "createdAt": "2024-03-15T10:30:00Z"
  }
}
```

### 成功レスポンス（一覧）

```json
{
  "data": [
    { "id": "123", "name": "John Doe" },
    { "id": "124", "name": "Jane Doe" }
  ],
  "meta": {
    "total": 100,
    "page": 1,
    "limit": 20
  }
}
```

### エラーレスポンス

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力値が不正です",
    "details": [
      { "field": "email", "message": "メールアドレスの形式が不正です" }
    ]
  }
}
```

---

## チェックリスト

### 設計時

- [ ] URLがリソース指向になっている
- [ ] HTTPメソッドが適切に選択されている
- [ ] ステータスコードが適切に定義されている
- [ ] リクエスト/レスポンス形式が統一されている
- [ ] エラーレスポンスが定義されている

### 実装時

- [ ] 入力バリデーションが実装されている
- [ ] 認証・認可が実装されている
- [ ] エラーハンドリングが実装されている
- [ ] ログ出力が適切に行われている
- [ ] テストが作成されている

### セキュリティ

- [ ] 入力がサニタイズされている
- [ ] SQLインジェクション対策がされている
- [ ] XSS対策がされている
- [ ] レート制限が考慮されている
- [ ] 機密情報がレスポンスに含まれていない

---

## アンチパターン

- 動詞をURLに含める: `/getUsers` → `GET /users`
- 全部POSTで処理: 意図が不明確 → HTTPメソッドを使い分ける
- ステータスコード200のみ: エラー判定困難 → 適切なステータスコードを返す
- エラー詳細を常に返す: セキュリティリスク → 本番は概要のみ返す

---

## 関連ファイル

- `skills/error-handling.md` - エラーハンドリング
- `skills/testing.md` - テスト設計
- `.agent/rules/dod.md` - Definition of Done
