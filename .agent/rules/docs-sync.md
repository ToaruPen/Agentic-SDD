# ドキュメント同期ルール

PRD、Epic、実装コード間の整合性を保つためのルール。

---

## 正本の階層

```
PRD（要件）  ← 最も優先度が高い
   │
   ▼
Epic（実装計画）
   │
   ▼
実装（コード）
```

**原則**: 上位ドキュメントが正本。矛盾がある場合は上位に従う。

---

## 同期タイミング

| タイミング | 実行 | 理由 |
|-----------|------|------|
| PR作成時 | **必須（DoD）** | 乖離を検出 |
| マージ後 | 推奨 | 確認用 |
| 実装中の大きな変更時 | 推奨 | 早期発見 |

---

## /sync-docs 出力形式

```markdown
## 同期結果

### 差分の種類
- [ ] 仕様変更（PRDの要求自体が変わる）
- [ ] 解釈変更（PRDの解釈が変わる）
- [ ] 実装都合（技術的制約による変更）

### 推奨アクション
- [ ] PRD更新が必要
- [ ] Epic更新が必要
- [ ] 実装修正が必要
- [ ] 差分なし（同期済み）

### 影響範囲
- [ ] テストへの影響
- [ ] 運用への影響
- [ ] ユーザーへの影響

### 参照（必須）
- PRD: [ファイル名] セクション [番号/名前]
- Epic: [ファイル名] セクション [番号/名前]
- 該当コード: [ファイル:行]

### 詳細
[差分の具体的な内容]
```

---

## 参照の書き方

### PRD参照

```
PRD: docs/prd/my-project.md セクション 5. AC
```

### Epic参照

```
Epic: docs/epics/my-project-epic.md セクション 3.2 技術選定
```

### コード参照

```
該当コード: src/api/handlers.ts:42-58
```

---

## 差分検出のルール

### 仕様変更（PRD更新が必要）

- ACの追加/削除/変更
- 機能要件の追加/削除/変更
- スコープの変更

### 解釈変更（Epic更新が必要）

- 技術選定の変更
- コンポーネント構成の変更
- データモデルの変更

### 実装都合（実装修正または理由記録）

- パフォーマンス最適化
- ライブラリの制約による回避策
- バグ修正

---

## 差分発見時の対応

1. **差分の種類を特定**
2. **参照を明記**（PRD/Epic/コードの該当箇所）
3. **推奨アクションを提示**
4. **ユーザーに確認**

**禁止事項:**
- 差分を暗黙的に無視する
- 参照なしで差分を報告する
- 上位ドキュメントを勝手に変更する

---

## 関連ファイル

- `.agent/commands/sync-docs.md` - 同期コマンド
- `.agent/rules/dod.md` - Definition of Done（sync-docs必須）
