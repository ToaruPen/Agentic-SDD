# テスト設計スキル

テスト戦略・種別・カバレッジ方針に関するガイドライン。

---

## 概要

このスキルは、アプリケーションのテスト設計・実装における
指針を提供します。
言語/フレームワーク非依存で、概念ベースで記述しています。

---

## テストピラミッド

```
        /\
       /  \
      / E2E \        少数・遅い・高コスト
     /-------\
    /Integration\    中程度
   /-------------\
  /    Unit       \  多数・速い・低コスト
 /-----------------\
```

| 種別 | 割合目安 | 実行速度 | メンテコスト |
|-----|---------|---------|------------|
| Unit | 70% | 速い | 低い |
| Integration | 20% | 中程度 | 中程度 |
| E2E | 10% | 遅い | 高い |

---

## テスト種別

### Unit テスト

**対象**: 単一の関数/クラス/モジュール

```
入力 → [テスト対象] → 出力
        ↓
    依存は モック化
```

**特徴**:
- 外部依存をモック化
- 高速に実行可能
- 境界値・異常系を網羅

### Integration テスト

**対象**: 複数コンポーネントの連携

```
[コンポーネントA] → [コンポーネントB] → [DB]
                    ↑
              実際の連携をテスト
```

**特徴**:
- 実際のDB/外部サービスを使用（またはテスト用）
- コンポーネント間の連携を確認
- Unit より遅いが、より現実に近い

### E2E テスト

**対象**: システム全体のフロー

```
[ブラウザ] → [API] → [DB]
    ↑
  ユーザー視点でテスト
```

**特徴**:
- ユーザーシナリオをテスト
- 最も遅いが、最も現実に近い
- 主要フローのみに絞る

---

## テストの書き方

### AAA パターン

```
// Arrange（準備）
const user = createTestUser();
const repository = new UserRepository();

// Act（実行）
const result = await repository.save(user);

// Assert（検証）
expect(result.id).toBeDefined();
expect(result.name).toBe(user.name);
```

### テスト名の命名

```
// パターン1: should〜when〜
"should return error when email is invalid"

// パターン2: 日本語（チームの方針による）
"メールアドレスが不正な場合、エラーを返す"

// パターン3: given-when-then
"given invalid email, when saving user, then returns validation error"
```

---

## カバレッジ

### カバレッジの種類

| 種類 | 説明 | 目標目安 |
|-----|------|---------|
| Line | 行カバレッジ | 80%+ |
| Branch | 分岐カバレッジ | 70%+ |
| Function | 関数カバレッジ | 90%+ |

### カバレッジの考え方

**高カバレッジ ≠ 高品質**

```
// カバレッジ100%だが意味のないテスト
test("adds numbers", () => {
  add(1, 2);  // アサーションなし！
});

// カバレッジは同じだが意味のあるテスト
test("adds numbers correctly", () => {
  expect(add(1, 2)).toBe(3);
  expect(add(-1, 1)).toBe(0);
  expect(add(0, 0)).toBe(0);
});
```

### カバレッジ除外の判断

| 除外してよい | 除外すべきでない |
|------------|----------------|
| 自動生成コード | ビジネスロジック |
| 設定ファイル | エラーハンドリング |
| 型定義のみ | 重要な分岐処理 |

---

## テスト対象の優先度

### 必ずテストすべき

| 対象 | 理由 |
|-----|------|
| ビジネスロジック | バグの影響が大きい |
| バリデーション | セキュリティに関わる |
| エラーハンドリング | 障害時の挙動を保証 |
| 境界値 | バグが発生しやすい |

### テストを検討すべき

| 対象 | 理由 |
|-----|------|
| 外部連携 | 障害対応に必要 |
| 複雑な条件分岐 | バグが入りやすい |
| パフォーマンスクリティカル | 劣化を検知 |

### テスト不要な場合も

| 対象 | 理由 |
|-----|------|
| 単純なgetter/setter | 自明 |
| フレームワークの機能 | 既にテスト済み |
| 一時的なコード | ROI が低い |

---

## テストデータ

### テストデータの管理

| 方法 | 用途 |
|-----|------|
| ファクトリ関数 | 動的にデータ生成 |
| Fixture ファイル | 静的なテストデータ |
| Seed データ | DBの初期データ |

### テストデータの原則

- 各テストは独立（他のテストに依存しない）
- テストごとにデータを準備・クリーンアップ
- 本番データをテストに使用しない

---

## モック/スタブ

### 使い分け

| 種類 | 用途 |
|-----|------|
| Mock | 呼び出しを検証したい |
| Stub | 固定値を返したい |
| Spy | 実際の処理 + 呼び出し記録 |
| Fake | 簡易的な代替実装 |

### モックの注意点

- モックしすぎると実際の動作と乖離
- 外部依存のみをモック（内部ロジックはモックしない）
- モックの戻り値は実際のAPIと一致させる

---

## チェックリスト

### テスト計画時

- [ ] テスト対象の優先度が決まっている
- [ ] テスト種別（Unit/Integration/E2E）が決まっている
- [ ] カバレッジ目標が設定されている

### テスト実装時

- [ ] AAAパターンで書かれている
- [ ] テスト名が内容を表している
- [ ] 正常系・異常系の両方がある
- [ ] 境界値がテストされている
- [ ] テスト同士が独立している

### テストメンテナンス時

- [ ] 不要なテストが削除されている
- [ ] 壊れたテストが放置されていない
- [ ] テストの実行時間が許容範囲内

---

## アンチパターン

| アンチパターン | 問題 | 改善 |
|---------------|------|------|
| アサーションなしのテスト | 何も検証していない | 意味のあるアサーション追加 |
| 1テストで複数の検証 | 失敗原因が不明確 | テストを分割 |
| テスト間の依存 | 実行順で結果が変わる | 各テストを独立に |
| 本番データ使用 | セキュリティリスク | テストデータを生成 |
| 遅いテストの放置 | CI が遅くなる | 最適化 or 分離 |
| カバレッジ100%信仰 | 意味のないテストが増える | 品質を重視 |

---

## 関連ファイル

- `skills/error-handling.md` - エラーハンドリング（異常系テスト）
- `skills/api-endpoint.md` - API設計（APIテスト）
- `.agent/rules/dod.md` - Definition of Done
